name: Pad_2_Pro_Kernel
on:
  workflow_dispatch:
    inputs:
      enable_feature_kpm:
        description: "KPM"
        required: false
        default: true
        type: boolean
      enable_feature_bbr:
        description: "BBR"
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: Build_Pad_2_Pro_Kernel
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - uses: actions/checkout@v4
        with:
          # Get the full Git history
          fetch-depth: 0

      - name: ⚙️ 设置全局环境变量 (Set Global Environment Variables)
        run: |
          echo "ENABLE_KPM=${{ github.event.inputs.enable_feature_kpm }}" >> $GITHUB_ENV
          echo "ENABLE_BBR=${{ github.event.inputs.enable_feature_bbr }}" >> $GITHUB_ENV
          echo "DEVICE_NAME=oneplus_pad_2_pro" >> $GITHUB_ENV
          echo "KERNEL_TIME=Tue Mar 4 09:04:13 UTC 2025" >> $GITHUB_ENV
          echo "DEFAULT_SUFFIX=-android15-8-g302cb15749a8-ab13157299-4k" >> $GITHUB_ENV

      - name: ⚙️ 设置缓存路径 (Set Cache Path)
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_$DEVICE_NAME" >> $GITHUB_ENV

      - name: 📥 设置下载账户 (Set Download Account)
        run: |
          git config --global user.name "MoranOrz"
          git config --global user.email "authorz@aliyun.com"

      - name: 🛠️ 配置 APT 缓存 (Configure APT Cache)
        run: |
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
          echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
          echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Dir::State::lists \"$APT_CACHE_DIR/lists\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Check-Valid-Until \"false\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Languages \"none\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          sudo chown -R $USER:$USER "$APT_CACHE_DIR"

      - name: 🛠️ 缓存 APT 包 ()Cache APT Packages)
        uses: actions/cache@v4
        with:
          path: ${{ env.HOME }}/apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/build_ak3.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: 📥 安装 APT 依赖 (Install APT Dependencies)
        run: |
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR/lists/partial"
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 p7zip-full git curl ccache libelf-dev \
            build-essential flex bison libssl-dev \
            libncurses-dev liblz4-tool zlib1g-dev \
            libxml2-utils rsync unzip
          echo "✅ 安装完成"

      - name: 📥 载入缓存 (Load Cache)
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref }}-${{ env.DEVICE_NAME }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.DEVICE_NAME }}-
            ccache-${{ runner.os }}-

      - name: 🤖 显示缓存状态 (Display Cache Status)
        run: |
          echo "APT缓存命中: ${{ steps.apt-cache.outputs.cache-hit }}"
          echo "ccache缓存命中: ${{ steps.ccache-cache.outputs.cache-hit }}"
